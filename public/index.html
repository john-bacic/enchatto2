<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> -->
  <title>enChatto</title>
  <base href="/" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="/styles.css" />
  <style>
    :root {
      --room-info-height: 0px;
    }
  </style>
</head>
<body>
  <!-- Host Welcome Screen -->
  <div id="start-host" class="welcome-screen" style="display: none;">
    <input type="text" id="host-name" placeholder="Enter your name (optional)" class="host-name-input" />
    <button onclick="startHosting()" class="host-button">Create New Room</button>
  </div>

  <!-- Guest Welcome Screen -->
  <div id="guest-name-prompt" class="welcome-screen" style="display: none;">
    <div class="guest-selection">
      <select id="previous-guests" class="guest-select" onchange="selectPreviousGuest()">
        <option value="">Select previous name or enter new one</option>
      </select>
    </div>
    <input type="text" id="guest-name" placeholder="Enter your name" class="guest-name-input" />
    <button onclick="joinAsGuest()" class="guest-button">Join Room</button>
  </div>

  <!-- Room Info (for Hosts) -->
  <div id="room-info" style="display: none;" class="room-info">
    <button class="accordion-button" onclick="toggleAccordion(this)">
      
      <svg width="141" height="31" viewBox="0 0 141 31" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g filter="url(#filter0_d_1181_166)">
        <mask id="path-1-outside-1_1181_166" maskUnits="userSpaceOnUse" x="0" y="0" width="140" height="30" fill="black">
        <rect fill="white" width="140" height="30"/>
        <path d="M10.708 13.256C9.928 13.256 9.33867 13.464 8.94 13.88C8.54133 14.2787 8.29 14.972 8.186 15.96C8.186 16.0987 8.24667 16.168 8.368 16.168H12.762C12.918 16.168 12.996 16.09 12.996 15.934C12.9267 14.1487 12.164 13.256 10.708 13.256ZM11.358 24.462C9.00067 24.462 7.18067 23.864 5.898 22.668C4.63267 21.472 4 19.73 4 17.442C4 15.1713 4.56333 13.438 5.69 12.242C6.834 11.0287 8.48067 10.422 10.63 10.422C14.7553 10.422 16.8527 12.6753 16.922 17.182C16.922 17.598 16.7573 17.9533 16.428 18.248C16.116 18.5253 15.752 18.664 15.336 18.664H8.394C8.22067 18.664 8.15133 18.742 8.186 18.898C8.32467 19.8513 8.68867 20.536 9.278 20.952C9.88467 21.3507 10.786 21.55 11.982 21.55C12.762 21.55 13.6027 21.4373 14.504 21.212C14.868 21.1253 15.1887 21.1947 15.466 21.42C15.7607 21.6453 15.908 21.94 15.908 22.304V22.356C15.908 22.7893 15.7693 23.188 15.492 23.552C15.232 23.8987 14.894 24.1067 14.478 24.176C13.4727 24.3667 12.4327 24.462 11.358 24.462Z"/>
        <path d="M21.0418 24.202C20.6431 24.202 20.2964 24.0547 20.0018 23.76C19.7244 23.4653 19.5858 23.1187 19.5858 22.72V12.164C19.5858 11.7653 19.7244 11.4187 20.0018 11.124C20.2964 10.8293 20.6431 10.682 21.0418 10.682H22.1078C22.5238 10.682 22.8704 10.8293 23.1478 11.124C23.4424 11.4013 23.5984 11.748 23.6158 12.164L23.6418 12.372C23.6418 12.3893 23.6504 12.398 23.6678 12.398L23.7198 12.346C24.8464 11.0633 26.1984 10.422 27.7758 10.422C29.3531 10.422 30.4884 10.8727 31.1818 11.774C31.8751 12.658 32.2218 14.1747 32.2218 16.324V22.72C32.2218 23.1187 32.0744 23.4653 31.7798 23.76C31.5024 24.0547 31.1644 24.202 30.7658 24.202H29.6218C29.2231 24.202 28.8764 24.0547 28.5818 23.76C28.2871 23.4653 28.1398 23.1187 28.1398 22.72V16.454C28.1398 15.414 28.0011 14.7033 27.7238 14.322C27.4464 13.9233 26.9438 13.724 26.2158 13.724C25.6091 13.724 25.0458 13.9753 24.5258 14.478C24.0231 14.9633 23.7718 15.492 23.7718 16.064V22.72C23.7718 23.1187 23.6244 23.4653 23.3298 23.76C23.0524 24.0547 22.7144 24.202 22.3158 24.202H21.0418Z"/>
        <path d="M36.9871 16.74C36.5884 16.74 36.2418 16.6013 35.9471 16.324C35.6524 16.0293 35.5051 15.6827 35.5051 15.284V14.452C35.5051 14.0533 35.6524 13.7067 35.9471 13.412C36.2418 13.1173 36.5884 12.97 36.9871 12.97H45.3071C45.4631 12.97 45.5411 12.9007 45.5411 12.762V9.59C45.5411 9.45133 45.4631 9.382 45.3071 9.382C44.2151 9.45133 42.3864 9.50333 39.8211 9.538C39.4051 9.538 39.0498 9.39933 38.7551 9.122C38.4604 8.84467 38.3131 8.498 38.3131 8.082V7.25C38.3131 6.834 38.4604 6.48733 38.7551 6.21C39.0498 5.91533 39.4051 5.768 39.8211 5.768C42.9758 5.75067 45.5931 5.612 47.6731 5.352C49.7531 5.092 51.6858 4.68467 53.4711 4.13C53.8524 4.00867 54.2164 4.04333 54.5631 4.234C54.9271 4.40733 55.1784 4.68467 55.3171 5.066L55.6031 5.924C55.7418 6.32267 55.7158 6.704 55.5251 7.068C55.3518 7.432 55.0744 7.67467 54.6931 7.796C53.1158 8.316 51.5731 8.68867 50.0651 8.914C49.9264 8.94867 49.8571 9.03533 49.8571 9.174V12.762C49.8571 12.9007 49.9264 12.97 50.0651 12.97H56.6431C57.0418 12.97 57.3884 13.1173 57.6831 13.412C57.9778 13.7067 58.1251 14.0533 58.1251 14.452V15.284C58.1251 15.6827 57.9778 16.0293 57.6831 16.324C57.3884 16.6013 57.0418 16.74 56.6431 16.74H49.8831C49.7444 16.74 49.6578 16.8267 49.6231 17C49.2764 19.4613 48.4791 21.3593 47.2311 22.694C46.0004 24.0287 44.1718 24.982 41.7451 25.554C41.3291 25.658 40.9391 25.5973 40.5751 25.372C40.2111 25.164 39.9598 24.852 39.8211 24.436L39.5351 23.578C39.4138 23.214 39.4484 22.8673 39.6391 22.538C39.8471 22.1913 40.1418 21.966 40.5231 21.862C42.0138 21.4633 43.1231 20.9 43.8511 20.172C44.5791 19.4267 45.0644 18.352 45.3071 16.948C45.3244 16.896 45.3071 16.8527 45.2551 16.818C45.2031 16.766 45.1511 16.74 45.0991 16.74H36.9871Z"/>
        <path d="M63.8191 15.258L63.7151 14.66C63.6458 14.2613 63.7238 13.8973 63.9491 13.568C64.1744 13.2387 64.4864 13.0307 64.8851 12.944L67.6151 12.398C67.7711 12.3633 67.8318 12.2767 67.7971 12.138L67.4071 9.98C67.3378 9.58133 67.4158 9.21733 67.6411 8.888C67.8838 8.54133 68.2044 8.33333 68.6031 8.264L69.5391 8.108C69.9378 8.03867 70.3018 8.12533 70.6311 8.368C70.9778 8.61067 71.1858 8.93133 71.2551 9.33L71.6191 11.384C71.6538 11.54 71.7404 11.6007 71.8791 11.566L80.0691 9.928C80.4678 9.85867 80.8318 9.93667 81.1611 10.162C81.4904 10.3873 81.6984 10.6993 81.7851 11.098L81.8891 11.696C82.0971 12.7533 82.0451 13.698 81.7331 14.53C81.0744 16.3847 80.1038 18.1007 78.8211 19.678C78.5438 20.0073 78.1971 20.1893 77.7811 20.224C77.3651 20.2413 76.9924 20.12 76.6631 19.86L76.0391 19.392C75.7271 19.1667 75.5538 18.8633 75.5191 18.482C75.4844 18.0833 75.5884 17.728 75.8311 17.416C76.7151 16.324 77.4171 15.2407 77.9371 14.166C77.9718 14.1313 77.9718 14.088 77.9371 14.036C77.9024 13.984 77.8591 13.9667 77.8071 13.984L72.4771 15.05C72.3211 15.0847 72.2604 15.1713 72.2951 15.31L73.7771 23.682C73.8464 24.0807 73.7598 24.4447 73.5171 24.774C73.2918 25.1207 72.9798 25.3287 72.5811 25.398L71.6451 25.554C71.2464 25.6233 70.8738 25.5367 70.5271 25.294C70.1978 25.0513 69.9984 24.7307 69.9291 24.332L68.4731 16.064C68.4384 15.908 68.3518 15.8473 68.2131 15.882L65.5351 16.428C65.1364 16.4973 64.7724 16.4193 64.4431 16.194C64.1138 15.9687 63.9058 15.6567 63.8191 15.258Z"/>
        <path d="M107.577 10.656C107.404 15.3533 106.381 18.8027 104.509 21.004C102.637 23.2053 99.6298 24.6007 95.4871 25.19C95.0711 25.2593 94.6898 25.164 94.3431 24.904C93.9964 24.6613 93.7798 24.332 93.6931 23.916L93.5891 23.422C93.5198 23.0407 93.5891 22.694 93.7971 22.382C94.0224 22.0527 94.3344 21.8533 94.7331 21.784C98.0091 21.264 100.314 20.1893 101.649 18.56C103.001 16.9133 103.755 14.218 103.911 10.474C103.928 10.0753 104.076 9.73733 104.353 9.46C104.648 9.18267 104.994 9.05267 105.393 9.07L106.121 9.122C106.52 9.15667 106.866 9.32133 107.161 9.616C107.456 9.91067 107.594 10.2573 107.577 10.656ZM91.5351 15.804C91.1191 14.0707 90.7724 12.7013 90.4951 11.696C90.3911 11.3147 90.4344 10.9507 90.6251 10.604C90.8331 10.2573 91.1364 10.0407 91.5351 9.954L92.0551 9.824C92.4538 9.73733 92.8264 9.798 93.1731 10.006C93.5371 10.214 93.7798 10.5173 93.9011 10.916C94.3691 12.6147 94.7418 13.984 95.0191 15.024C95.1231 15.4053 95.0624 15.7693 94.8371 16.116C94.6291 16.4627 94.3258 16.6793 93.9271 16.766L93.3031 16.922C92.9044 17.0087 92.5318 16.948 92.1851 16.74C91.8384 16.5147 91.6218 16.2027 91.5351 15.804ZM98.9711 16.402C98.5724 16.4887 98.1998 16.428 97.8531 16.22C97.5064 16.012 97.2811 15.7173 97.1771 15.336C97.1598 15.232 96.7871 13.8193 96.0591 11.098C95.9551 10.6993 96.0071 10.3267 96.2151 9.98C96.4231 9.616 96.7178 9.39067 97.0991 9.304L97.6971 9.174C98.0958 9.08733 98.4771 9.148 98.8411 9.356C99.2051 9.564 99.4391 9.86733 99.5431 10.266C100.028 12.0513 100.401 13.464 100.661 14.504C100.765 14.8853 100.704 15.258 100.479 15.622C100.271 15.9687 99.9678 16.1853 99.5691 16.272L98.9711 16.402Z"/>
        <path d="M118.835 25.684C118.436 25.684 118.09 25.5367 117.795 25.242C117.5 24.9473 117.353 24.6007 117.353 24.202V5.482C117.353 5.08333 117.5 4.73667 117.795 4.442C118.09 4.14733 118.436 4 118.835 4H120.317C120.716 4 121.054 4.14733 121.331 4.442C121.626 4.73667 121.773 5.08333 121.773 5.482V10.942C121.773 11.098 121.851 11.1933 122.007 11.228C126.08 12.2333 130.197 13.464 134.357 14.92C134.738 15.0413 135.024 15.2927 135.215 15.674C135.406 16.038 135.432 16.4193 135.293 16.818L134.877 17.988C134.738 18.3693 134.496 18.6467 134.149 18.82C133.802 18.9933 133.438 19.0193 133.057 18.898C129.504 17.6327 125.812 16.506 121.981 15.518C121.842 15.4833 121.773 15.544 121.773 15.7V24.202C121.773 24.6007 121.626 24.9473 121.331 25.242C121.054 25.5367 120.716 25.684 120.317 25.684H118.835Z"/>
        </mask>
        <path d="M10.708 13.256C9.928 13.256 9.33867 13.464 8.94 13.88C8.54133 14.2787 8.29 14.972 8.186 15.96C8.186 16.0987 8.24667 16.168 8.368 16.168H12.762C12.918 16.168 12.996 16.09 12.996 15.934C12.9267 14.1487 12.164 13.256 10.708 13.256ZM11.358 24.462C9.00067 24.462 7.18067 23.864 5.898 22.668C4.63267 21.472 4 19.73 4 17.442C4 15.1713 4.56333 13.438 5.69 12.242C6.834 11.0287 8.48067 10.422 10.63 10.422C14.7553 10.422 16.8527 12.6753 16.922 17.182C16.922 17.598 16.7573 17.9533 16.428 18.248C16.116 18.5253 15.752 18.664 15.336 18.664H8.394C8.22067 18.664 8.15133 18.742 8.186 18.898C8.32467 19.8513 8.68867 20.536 9.278 20.952C9.88467 21.3507 10.786 21.55 11.982 21.55C12.762 21.55 13.6027 21.4373 14.504 21.212C14.868 21.1253 15.1887 21.1947 15.466 21.42C15.7607 21.6453 15.908 21.94 15.908 22.304V22.356C15.908 22.7893 15.7693 23.188 15.492 23.552C15.232 23.8987 14.894 24.1067 14.478 24.176C13.4727 24.3667 12.4327 24.462 11.358 24.462Z" fill="#68B7CF"/>
        <path d="M21.0418 24.202C20.6431 24.202 20.2964 24.0547 20.0018 23.76C19.7244 23.4653 19.5858 23.1187 19.5858 22.72V12.164C19.5858 11.7653 19.7244 11.4187 20.0018 11.124C20.2964 10.8293 20.6431 10.682 21.0418 10.682H22.1078C22.5238 10.682 22.8704 10.8293 23.1478 11.124C23.4424 11.4013 23.5984 11.748 23.6158 12.164L23.6418 12.372C23.6418 12.3893 23.6504 12.398 23.6678 12.398L23.7198 12.346C24.8464 11.0633 26.1984 10.422 27.7758 10.422C29.3531 10.422 30.4884 10.8727 31.1818 11.774C31.8751 12.658 32.2218 14.1747 32.2218 16.324V22.72C32.2218 23.1187 32.0744 23.4653 31.7798 23.76C31.5024 24.0547 31.1644 24.202 30.7658 24.202H29.6218C29.2231 24.202 28.8764 24.0547 28.5818 23.76C28.2871 23.4653 28.1398 23.1187 28.1398 22.72V16.454C28.1398 15.414 28.0011 14.7033 27.7238 14.322C27.4464 13.9233 26.9438 13.724 26.2158 13.724C25.6091 13.724 25.0458 13.9753 24.5258 14.478C24.0231 14.9633 23.7718 15.492 23.7718 16.064V22.72C23.7718 23.1187 23.6244 23.4653 23.3298 23.76C23.0524 24.0547 22.7144 24.202 22.3158 24.202H21.0418Z" fill="#68B7CF"/>
        <path d="M36.9871 16.74C36.5884 16.74 36.2418 16.6013 35.9471 16.324C35.6524 16.0293 35.5051 15.6827 35.5051 15.284V14.452C35.5051 14.0533 35.6524 13.7067 35.9471 13.412C36.2418 13.1173 36.5884 12.97 36.9871 12.97H45.3071C45.4631 12.97 45.5411 12.9007 45.5411 12.762V9.59C45.5411 9.45133 45.4631 9.382 45.3071 9.382C44.2151 9.45133 42.3864 9.50333 39.8211 9.538C39.4051 9.538 39.0498 9.39933 38.7551 9.122C38.4604 8.84467 38.3131 8.498 38.3131 8.082V7.25C38.3131 6.834 38.4604 6.48733 38.7551 6.21C39.0498 5.91533 39.4051 5.768 39.8211 5.768C42.9758 5.75067 45.5931 5.612 47.6731 5.352C49.7531 5.092 51.6858 4.68467 53.4711 4.13C53.8524 4.00867 54.2164 4.04333 54.5631 4.234C54.9271 4.40733 55.1784 4.68467 55.3171 5.066L55.6031 5.924C55.7418 6.32267 55.7158 6.704 55.5251 7.068C55.3518 7.432 55.0744 7.67467 54.6931 7.796C53.1158 8.316 51.5731 8.68867 50.0651 8.914C49.9264 8.94867 49.8571 9.03533 49.8571 9.174V12.762C49.8571 12.9007 49.9264 12.97 50.0651 12.97H56.6431C57.0418 12.97 57.3884 13.1173 57.6831 13.412C57.9778 13.7067 58.1251 14.0533 58.1251 14.452V15.284C58.1251 15.6827 57.9778 16.0293 57.6831 16.324C57.3884 16.6013 57.0418 16.74 56.6431 16.74H49.8831C49.7444 16.74 49.6578 16.8267 49.6231 17C49.2764 19.4613 48.4791 21.3593 47.2311 22.694C46.0004 24.0287 44.1718 24.982 41.7451 25.554C41.3291 25.658 40.9391 25.5973 40.5751 25.372C40.2111 25.164 39.9598 24.852 39.8211 24.436L39.5351 23.578C39.4138 23.214 39.4484 22.8673 39.6391 22.538C39.8471 22.1913 40.1418 21.966 40.5231 21.862C42.0138 21.4633 43.1231 20.9 43.8511 20.172C44.5791 19.4267 45.0644 18.352 45.3071 16.948C45.3244 16.896 45.3071 16.8527 45.2551 16.818C45.2031 16.766 45.1511 16.74 45.0991 16.74H36.9871Z" fill="#68B7CF"/>
        <path d="M63.8191 15.258L63.7151 14.66C63.6458 14.2613 63.7238 13.8973 63.9491 13.568C64.1744 13.2387 64.4864 13.0307 64.8851 12.944L67.6151 12.398C67.7711 12.3633 67.8318 12.2767 67.7971 12.138L67.4071 9.98C67.3378 9.58133 67.4158 9.21733 67.6411 8.888C67.8838 8.54133 68.2044 8.33333 68.6031 8.264L69.5391 8.108C69.9378 8.03867 70.3018 8.12533 70.6311 8.368C70.9778 8.61067 71.1858 8.93133 71.2551 9.33L71.6191 11.384C71.6538 11.54 71.7404 11.6007 71.8791 11.566L80.0691 9.928C80.4678 9.85867 80.8318 9.93667 81.1611 10.162C81.4904 10.3873 81.6984 10.6993 81.7851 11.098L81.8891 11.696C82.0971 12.7533 82.0451 13.698 81.7331 14.53C81.0744 16.3847 80.1038 18.1007 78.8211 19.678C78.5438 20.0073 78.1971 20.1893 77.7811 20.224C77.3651 20.2413 76.9924 20.12 76.6631 19.86L76.0391 19.392C75.7271 19.1667 75.5538 18.8633 75.5191 18.482C75.4844 18.0833 75.5884 17.728 75.8311 17.416C76.7151 16.324 77.4171 15.2407 77.9371 14.166C77.9718 14.1313 77.9718 14.088 77.9371 14.036C77.9024 13.984 77.8591 13.9667 77.8071 13.984L72.4771 15.05C72.3211 15.0847 72.2604 15.1713 72.2951 15.31L73.7771 23.682C73.8464 24.0807 73.7598 24.4447 73.5171 24.774C73.2918 25.1207 72.9798 25.3287 72.5811 25.398L71.6451 25.554C71.2464 25.6233 70.8738 25.5367 70.5271 25.294C70.1978 25.0513 69.9984 24.7307 69.9291 24.332L68.4731 16.064C68.4384 15.908 68.3518 15.8473 68.2131 15.882L65.5351 16.428C65.1364 16.4973 64.7724 16.4193 64.4431 16.194C64.1138 15.9687 63.9058 15.6567 63.8191 15.258Z" fill="#68B7CF"/>
        <path d="M107.577 10.656C107.404 15.3533 106.381 18.8027 104.509 21.004C102.637 23.2053 99.6298 24.6007 95.4871 25.19C95.0711 25.2593 94.6898 25.164 94.3431 24.904C93.9964 24.6613 93.7798 24.332 93.6931 23.916L93.5891 23.422C93.5198 23.0407 93.5891 22.694 93.7971 22.382C94.0224 22.0527 94.3344 21.8533 94.7331 21.784C98.0091 21.264 100.314 20.1893 101.649 18.56C103.001 16.9133 103.755 14.218 103.911 10.474C103.928 10.0753 104.076 9.73733 104.353 9.46C104.648 9.18267 104.994 9.05267 105.393 9.07L106.121 9.122C106.52 9.15667 106.866 9.32133 107.161 9.616C107.456 9.91067 107.594 10.2573 107.577 10.656ZM91.5351 15.804C91.1191 14.0707 90.7724 12.7013 90.4951 11.696C90.3911 11.3147 90.4344 10.9507 90.6251 10.604C90.8331 10.2573 91.1364 10.0407 91.5351 9.954L92.0551 9.824C92.4538 9.73733 92.8264 9.798 93.1731 10.006C93.5371 10.214 93.7798 10.5173 93.9011 10.916C94.3691 12.6147 94.7418 13.984 95.0191 15.024C95.1231 15.4053 95.0624 15.7693 94.8371 16.116C94.6291 16.4627 94.3258 16.6793 93.9271 16.766L93.3031 16.922C92.9044 17.0087 92.5318 16.948 92.1851 16.74C91.8384 16.5147 91.6218 16.2027 91.5351 15.804ZM98.9711 16.402C98.5724 16.4887 98.1998 16.428 97.8531 16.22C97.5064 16.012 97.2811 15.7173 97.1771 15.336C97.1598 15.232 96.7871 13.8193 96.0591 11.098C95.9551 10.6993 96.0071 10.3267 96.2151 9.98C96.4231 9.616 96.7178 9.39067 97.0991 9.304L97.6971 9.174C98.0958 9.08733 98.4771 9.148 98.8411 9.356C99.2051 9.564 99.4391 9.86733 99.5431 10.266C100.028 12.0513 100.401 13.464 100.661 14.504C100.765 14.8853 100.704 15.258 100.479 15.622C100.271 15.9687 99.9678 16.1853 99.5691 16.272L98.9711 16.402Z" fill="#68B7CF"/>
        <path d="M118.835 25.684C118.436 25.684 118.09 25.5367 117.795 25.242C117.5 24.9473 117.353 24.6007 117.353 24.202V5.482C117.353 5.08333 117.5 4.73667 117.795 4.442C118.09 4.14733 118.436 4 118.835 4H120.317C120.716 4 121.054 4.14733 121.331 4.442C121.626 4.73667 121.773 5.08333 121.773 5.482V10.942C121.773 11.098 121.851 11.1933 122.007 11.228C126.08 12.2333 130.197 13.464 134.357 14.92C134.738 15.0413 135.024 15.2927 135.215 15.674C135.406 16.038 135.432 16.4193 135.293 16.818L134.877 17.988C134.738 18.3693 134.496 18.6467 134.149 18.82C133.802 18.9933 133.438 19.0193 133.057 18.898C129.504 17.6327 125.812 16.506 121.981 15.518C121.842 15.4833 121.773 15.544 121.773 15.7V24.202C121.773 24.6007 121.626 24.9473 121.331 25.242C121.054 25.5367 120.716 25.684 120.317 25.684H118.835Z" fill="#68B7CF"/>
        <path d="M10.708 13.256C9.928 13.256 9.33867 13.464 8.94 13.88C8.54133 14.2787 8.29 14.972 8.186 15.96C8.186 16.0987 8.24667 16.168 8.368 16.168H12.762C12.918 16.168 12.996 16.09 12.996 15.934C12.9267 14.1487 12.164 13.256 10.708 13.256ZM11.358 24.462C9.00067 24.462 7.18067 23.864 5.898 22.668C4.63267 21.472 4 19.73 4 17.442C4 15.1713 4.56333 13.438 5.69 12.242C6.834 11.0287 8.48067 10.422 10.63 10.422C14.7553 10.422 16.8527 12.6753 16.922 17.182C16.922 17.598 16.7573 17.9533 16.428 18.248C16.116 18.5253 15.752 18.664 15.336 18.664H8.394C8.22067 18.664 8.15133 18.742 8.186 18.898C8.32467 19.8513 8.68867 20.536 9.278 20.952C9.88467 21.3507 10.786 21.55 11.982 21.55C12.762 21.55 13.6027 21.4373 14.504 21.212C14.868 21.1253 15.1887 21.1947 15.466 21.42C15.7607 21.6453 15.908 21.94 15.908 22.304V22.356C15.908 22.7893 15.7693 23.188 15.492 23.552C15.232 23.8987 14.894 24.1067 14.478 24.176C13.4727 24.3667 12.4327 24.462 11.358 24.462Z" stroke="white" stroke-width="8" mask="url(#path-1-outside-1_1181_166)"/>
        <path d="M21.0418 24.202C20.6431 24.202 20.2964 24.0547 20.0018 23.76C19.7244 23.4653 19.5858 23.1187 19.5858 22.72V12.164C19.5858 11.7653 19.7244 11.4187 20.0018 11.124C20.2964 10.8293 20.6431 10.682 21.0418 10.682H22.1078C22.5238 10.682 22.8704 10.8293 23.1478 11.124C23.4424 11.4013 23.5984 11.748 23.6158 12.164L23.6418 12.372C23.6418 12.3893 23.6504 12.398 23.6678 12.398L23.7198 12.346C24.8464 11.0633 26.1984 10.422 27.7758 10.422C29.3531 10.422 30.4884 10.8727 31.1818 11.774C31.8751 12.658 32.2218 14.1747 32.2218 16.324V22.72C32.2218 23.1187 32.0744 23.4653 31.7798 23.76C31.5024 24.0547 31.1644 24.202 30.7658 24.202H29.6218C29.2231 24.202 28.8764 24.0547 28.5818 23.76C28.2871 23.4653 28.1398 23.1187 28.1398 22.72V16.454C28.1398 15.414 28.0011 14.7033 27.7238 14.322C27.4464 13.9233 26.9438 13.724 26.2158 13.724C25.6091 13.724 25.0458 13.9753 24.5258 14.478C24.0231 14.9633 23.7718 15.492 23.7718 16.064V22.72C23.7718 23.1187 23.6244 23.4653 23.3298 23.76C23.0524 24.0547 22.7144 24.202 22.3158 24.202H21.0418Z" stroke="white" stroke-width="8" mask="url(#path-1-outside-1_1181_166)"/>
        <path d="M36.9871 16.74C36.5884 16.74 36.2418 16.6013 35.9471 16.324C35.6524 16.0293 35.5051 15.6827 35.5051 15.284V14.452C35.5051 14.0533 35.6524 13.7067 35.9471 13.412C36.2418 13.1173 36.5884 12.97 36.9871 12.97H45.3071C45.4631 12.97 45.5411 12.9007 45.5411 12.762V9.59C45.5411 9.45133 45.4631 9.382 45.3071 9.382C44.2151 9.45133 42.3864 9.50333 39.8211 9.538C39.4051 9.538 39.0498 9.39933 38.7551 9.122C38.4604 8.84467 38.3131 8.498 38.3131 8.082V7.25C38.3131 6.834 38.4604 6.48733 38.7551 6.21C39.0498 5.91533 39.4051 5.768 39.8211 5.768C42.9758 5.75067 45.5931 5.612 47.6731 5.352C49.7531 5.092 51.6858 4.68467 53.4711 4.13C53.8524 4.00867 54.2164 4.04333 54.5631 4.234C54.9271 4.40733 55.1784 4.68467 55.3171 5.066L55.6031 5.924C55.7418 6.32267 55.7158 6.704 55.5251 7.068C55.3518 7.432 55.0744 7.67467 54.6931 7.796C53.1158 8.316 51.5731 8.68867 50.0651 8.914C49.9264 8.94867 49.8571 9.03533 49.8571 9.174V12.762C49.8571 12.9007 49.9264 12.97 50.0651 12.97H56.6431C57.0418 12.97 57.3884 13.1173 57.6831 13.412C57.9778 13.7067 58.1251 14.0533 58.1251 14.452V15.284C58.1251 15.6827 57.9778 16.0293 57.6831 16.324C57.3884 16.6013 57.0418 16.74 56.6431 16.74H49.8831C49.7444 16.74 49.6578 16.8267 49.6231 17C49.2764 19.4613 48.4791 21.3593 47.2311 22.694C46.0004 24.0287 44.1718 24.982 41.7451 25.554C41.3291 25.658 40.9391 25.5973 40.5751 25.372C40.2111 25.164 39.9598 24.852 39.8211 24.436L39.5351 23.578C39.4138 23.214 39.4484 22.8673 39.6391 22.538C39.8471 22.1913 40.1418 21.966 40.5231 21.862C42.0138 21.4633 43.1231 20.9 43.8511 20.172C44.5791 19.4267 45.0644 18.352 45.3071 16.948C45.3244 16.896 45.3071 16.8527 45.2551 16.818C45.2031 16.766 45.1511 16.74 45.0991 16.74H36.9871Z" stroke="white" stroke-width="8" mask="url(#path-1-outside-1_1181_166)"/>
        <path d="M63.8191 15.258L63.7151 14.66C63.6458 14.2613 63.7238 13.8973 63.9491 13.568C64.1744 13.2387 64.4864 13.0307 64.8851 12.944L67.6151 12.398C67.7711 12.3633 67.8318 12.2767 67.7971 12.138L67.4071 9.98C67.3378 9.58133 67.4158 9.21733 67.6411 8.888C67.8838 8.54133 68.2044 8.33333 68.6031 8.264L69.5391 8.108C69.9378 8.03867 70.3018 8.12533 70.6311 8.368C70.9778 8.61067 71.1858 8.93133 71.2551 9.33L71.6191 11.384C71.6538 11.54 71.7404 11.6007 71.8791 11.566L80.0691 9.928C80.4678 9.85867 80.8318 9.93667 81.1611 10.162C81.4904 10.3873 81.6984 10.6993 81.7851 11.098L81.8891 11.696C82.0971 12.7533 82.0451 13.698 81.7331 14.53C81.0744 16.3847 80.1038 18.1007 78.8211 19.678C78.5438 20.0073 78.1971 20.1893 77.7811 20.224C77.3651 20.2413 76.9924 20.12 76.6631 19.86L76.0391 19.392C75.7271 19.1667 75.5538 18.8633 75.5191 18.482C75.4844 18.0833 75.5884 17.728 75.8311 17.416C76.7151 16.324 77.4171 15.2407 77.9371 14.166C77.9718 14.1313 77.9718 14.088 77.9371 14.036C77.9024 13.984 77.8591 13.9667 77.8071 13.984L72.4771 15.05C72.3211 15.0847 72.2604 15.1713 72.2951 15.31L73.7771 23.682C73.8464 24.0807 73.7598 24.4447 73.5171 24.774C73.2918 25.1207 72.9798 25.3287 72.5811 25.398L71.6451 25.554C71.2464 25.6233 70.8738 25.5367 70.5271 25.294C70.1978 25.0513 69.9984 24.7307 69.9291 24.332L68.4731 16.064C68.4384 15.908 68.3518 15.8473 68.2131 15.882L65.5351 16.428C65.1364 16.4973 64.7724 16.4193 64.4431 16.194C64.1138 15.9687 63.9058 15.6567 63.8191 15.258Z" stroke="white" stroke-width="8" mask="url(#path-1-outside-1_1181_166)"/>
        <path d="M107.577 10.656C107.404 15.3533 106.381 18.8027 104.509 21.004C102.637 23.2053 99.6298 24.6007 95.4871 25.19C95.0711 25.2593 94.6898 25.164 94.3431 24.904C93.9964 24.6613 93.7798 24.332 93.6931 23.916L93.5891 23.422C93.5198 23.0407 93.5891 22.694 93.7971 22.382C94.0224 22.0527 94.3344 21.8533 94.7331 21.784C98.0091 21.264 100.314 20.1893 101.649 18.56C103.001 16.9133 103.755 14.218 103.911 10.474C103.928 10.0753 104.076 9.73733 104.353 9.46C104.648 9.18267 104.994 9.05267 105.393 9.07L106.121 9.122C106.52 9.15667 106.866 9.32133 107.161 9.616C107.456 9.91067 107.594 10.2573 107.577 10.656ZM91.5351 15.804C91.1191 14.0707 90.7724 12.7013 90.4951 11.696C90.3911 11.3147 90.4344 10.9507 90.6251 10.604C90.8331 10.2573 91.1364 10.0407 91.5351 9.954L92.0551 9.824C92.4538 9.73733 92.8264 9.798 93.1731 10.006C93.5371 10.214 93.7798 10.5173 93.9011 10.916C94.3691 12.6147 94.7418 13.984 95.0191 15.024C95.1231 15.4053 95.0624 15.7693 94.8371 16.116C94.6291 16.4627 94.3258 16.6793 93.9271 16.766L93.3031 16.922C92.9044 17.0087 92.5318 16.948 92.1851 16.74C91.8384 16.5147 91.6218 16.2027 91.5351 15.804ZM98.9711 16.402C98.5724 16.4887 98.1998 16.428 97.8531 16.22C97.5064 16.012 97.2811 15.7173 97.1771 15.336C97.1598 15.232 96.7871 13.8193 96.0591 11.098C95.9551 10.6993 96.0071 10.3267 96.2151 9.98C96.4231 9.616 96.7178 9.39067 97.0991 9.304L97.6971 9.174C98.0958 9.08733 98.4771 9.148 98.8411 9.356C99.2051 9.564 99.4391 9.86733 99.5431 10.266C100.028 12.0513 100.401 13.464 100.661 14.504C100.765 14.8853 100.704 15.258 100.479 15.622C100.271 15.9687 99.9678 16.1853 99.5691 16.272L98.9711 16.402Z" stroke="white" stroke-width="8" mask="url(#path-1-outside-1_1181_166)"/>
        <path d="M118.835 25.684C118.436 25.684 118.09 25.5367 117.795 25.242C117.5 24.9473 117.353 24.6007 117.353 24.202V5.482C117.353 5.08333 117.5 4.73667 117.795 4.442C118.09 4.14733 118.436 4 118.835 4H120.317C120.716 4 121.054 4.14733 121.331 4.442C121.626 4.73667 121.773 5.08333 121.773 5.482V10.942C121.773 11.098 121.851 11.1933 122.007 11.228C126.08 12.2333 130.197 13.464 134.357 14.92C134.738 15.0413 135.024 15.2927 135.215 15.674C135.406 16.038 135.432 16.4193 135.293 16.818L134.877 17.988C134.738 18.3693 134.496 18.6467 134.149 18.82C133.802 18.9933 133.438 19.0193 133.057 18.898C129.504 17.6327 125.812 16.506 121.981 15.518C121.842 15.4833 121.773 15.544 121.773 15.7V24.202C121.773 24.6007 121.626 24.9473 121.331 25.242C121.054 25.5367 120.716 25.684 120.317 25.684H118.835Z" stroke="white" stroke-width="8" mask="url(#path-1-outside-1_1181_166)"/>
        </g>
        <defs>
        <filter id="filter0_d_1181_166" x="0" y="0" width="140.381" height="30.6841" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
        <feFlood flood-opacity="0" result="BackgroundImageFix"/>
        <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
        <feOffset dx="1" dy="1"/>
        <feComposite in2="hardAlpha" operator="out"/>
        <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0"/>
        <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_1181_166"/>
        <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_1181_166" result="shape"/>
        </filter>
        </defs>
        </svg>
        

    </button>
    <div class="accordion-content">
      <div id="qr-code">
        <div class="loading">Loading QR code...</div>
      </div>
      <div class="info">
        <div>Room Number: <strong id="room-id">Loading...</strong></div>
        <div class="url-container">
          <strong id="join-url">Loading...</strong>
          <button onclick="copyUrl()" class="copy-button" id="copy-button">Copy</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Container -->
  <div id="chat-container" style="display: none;" class="chat-container">
    <div class="room-info-language">
      <div class="chat-header">
        <div class="language-toggles">
          <label class="toggle" for="en-toggle">
            <input type="checkbox" id="en-toggle" checked />
            <span>EN</span>
          </label>
          <label class="toggle" for="jp-toggle">
            <input type="checkbox" id="jp-toggle" checked />
            <span>JP</span>
          </label>
          <label class="toggle" for="rp-toggle">
            <input type="checkbox" id="rp-toggle" checked />
            <span>Ro</span>
          </label>
        </div>
      </div>
      <div id="welcome-message"></div>
    </div>
    <!-- <div id="welcome-message"></div> -->
    <div id="messages"></div>
    <div class="message-input-container">
      <div class="message-input">
        <textarea id="message-text" placeholder="Message..." autocomplete="off" rows="1"></textarea>
        <button onclick="sendMessage()" class="send-button" id="send-button">
            <svg viewBox="0 0 18 18">
                <path fill="black" d="M9 5.5L14.5 14H3z" />
            </svg>                          
        </button>
      </div>
    </div>
  </div>

  <!-- Socket.IO Library -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Initialize socket with reconnection settings
    const socket = io({
      reconnection: true,
      reconnectionAttempts: 5,
      reconnectionDelay: 1000,
      timeout: 10000,
      transports: ['websocket', 'polling']
    });
    
    let username = null;
    let userColor = null;
    const urlParams = new URLSearchParams(window.location.search);
    let isHost = urlParams.get('host') === 'true';
    const roomId = window.location.pathname.split('/').pop();
  
    // Load stored names from localStorage
    const storedHostName = localStorage.getItem('chatHostUsername');
    const storedGuestInfo = JSON.parse(localStorage.getItem('chatGuestInfo') || '{}');
  
    // Helper to store guest info and update the dropdown
    function storeGuestInfo(username, color) {
      const guestInfo = JSON.parse(localStorage.getItem('chatGuestInfo') || '{}');
      guestInfo[username] = { color, lastUsed: new Date().toISOString() };
      localStorage.setItem('chatGuestInfo', JSON.stringify(guestInfo));
      updateGuestSelect();
      // Update room info language color
      const roomInfoLanguage = document.querySelector('.room-info-language');
      if (roomInfoLanguage) {
        roomInfoLanguage.style.backgroundColor = color;
      }
    }
  
    function getGuestInfo(username) {
      const guestInfo = JSON.parse(localStorage.getItem('chatGuestInfo') || '{}');
      return guestInfo[username];
    }
  
    function updateGuestSelect() {
      const select = document.getElementById('previous-guests');
      if (!select) return;
      const guestInfo = JSON.parse(localStorage.getItem('chatGuestInfo') || '{}');
      const guests = Object.entries(guestInfo).sort((a, b) => new Date(b[1].lastUsed) - new Date(a[1].lastUsed));
      // Remove all options except the first
      while (select.options.length > 1) { select.remove(1); }
      guests.forEach(([username, info]) => {
        const option = document.createElement('option');
        option.value = username;
        option.textContent = username;
        option.style.color = info.color || '#000';
        select.appendChild(option);
      });
    }
  
    if (storedHostName) {
      const hostNameInput = document.getElementById('host-name');
      if (hostNameInput) hostNameInput.value = storedHostName;
    }
    if (!isHost) { 
      updateGuestSelect();
  
      // Prepopulate the guest name input just like the host
      const storedGuestName = localStorage.getItem('chatGuestUsername');
      if (storedGuestName) {
        const guestNameInput = document.getElementById('guest-name');
        if (guestNameInput) {
          guestNameInput.value = storedGuestName;
          const guestInfo = getGuestInfo(storedGuestName);
          if (guestInfo && guestInfo.color) {
            guestNameInput.style.borderColor = guestInfo.color;
          }
        }
      }
    }
  
    // Show/hide sections based on the URL and host flag
    if (window.location.pathname === '/' || window.location.pathname === '') {
      document.getElementById('start-host').style.display = 'flex';
      document.getElementById('room-info').style.display = 'none';
      document.getElementById('chat-container').style.display = 'none';
    } else if (!isHost) {
      document.getElementById('start-host').style.display = 'none';
      document.getElementById('guest-name-prompt').style.display = 'flex';
      document.getElementById('room-info').style.display = 'none';
      document.getElementById('chat-container').style.display = 'none';
    } else {
      document.getElementById('start-host').style.display = 'none';
      document.getElementById('guest-name-prompt').style.display = 'none';
      document.getElementById('room-info').style.display = isHost ? 'block' : 'none';
      document.getElementById('chat-container').style.display = 'flex';
      initializeRoom();
    }
  
    function toggleAccordion(button) {
      button.classList.toggle('active');
      const content = button.nextElementSibling;
      content.classList.toggle('show');
      
      // Save the new state
      saveAccordionState(button.classList.contains('active'));
      
      // Update height
      const roomInfo = document.querySelector('.room-info');
      if (roomInfo) {
        document.documentElement.style.setProperty('--room-info-height', roomInfo.offsetHeight + 'px');
      }
    }

    // Function to load accordion state
    function loadAccordionState(isNewRoom = false) {
      const button = document.querySelector('.accordion-button');
      if (!button) return; // Exit if button is not found
      
      const content = button.nextElementSibling;
      if (!content) return; // Exit if content is not found
      
      if (isNewRoom) {
        // For new rooms, always start open
        button.classList.add('active');
        content.classList.add('show');
        saveAccordionState(true);
      } else {
        // For existing rooms, load the saved state
        const isActive = localStorage.getItem('accordionState');
        console.log('Loading accordion state:', isActive); // Debug log
        
        if (isActive === 'true') {
          button.classList.add('active');
          content.classList.add('show');
        } else {
          button.classList.remove('active');
          content.classList.remove('show');
        }
      }
      
      // Update room info height
      const roomInfo = document.querySelector('.room-info');
      if (roomInfo) {
        document.documentElement.style.setProperty('--room-info-height', roomInfo.offsetHeight + 'px');
      }
    }

    // Function to save accordion state
    function saveAccordionState(isActive) {
      console.log('Saving accordion state:', isActive); // Debug log
      localStorage.setItem('accordionState', isActive);
    }

    function updateRoomInfoHeight() {
      const roomInfo = document.querySelector('.room-info');
      if (roomInfo) {
        document.documentElement.style.setProperty('--room-info-height', roomInfo.offsetHeight + 'px');
      }
    }
  
    // Update room-info height on content changes using ResizeObserver
    const observer = new ResizeObserver(entries => {
      for (let entry of entries) {
        if (entry.target.classList.contains('room-info')) {
          document.documentElement.style.setProperty('--room-info-height', entry.target.offsetHeight + 'px');
        }
      }
    });
    const roomInfoElement = document.querySelector('.room-info');
    if (roomInfoElement) { observer.observe(roomInfoElement); }
  
    // Prevent bounce scrolling on iOS (except in the messages area)
    document.addEventListener('touchmove', function(e) {
      if (e.target.closest('#messages')) return;
      e.preventDefault();
    }, { passive: false });
  
    function startHosting() {
      const storedName = localStorage.getItem('chatHostUsername');
      const hostName = document.getElementById('host-name').value.trim() || storedName || 'Host';
      localStorage.setItem('chatHostUsername', hostName);
      // Set a flag for new room
      sessionStorage.setItem('isNewRoom', 'true');
      window.location.href = `/room?host=true&hostName=${encodeURIComponent(hostName)}`;
    }
  
    function joinAsGuest() {
      const guestName = document.getElementById('guest-name').value.trim();
      if (!guestName) {
        alert('Please enter a name');
        return;
      }
      // Save the guest name for future visits (just like the host)
      localStorage.setItem('chatGuestUsername', guestName);
      const existingInfo = getGuestInfo(guestName);
      const guestColor = existingInfo ? existingInfo.color : null;
      storeGuestInfo(guestName, guestColor);
      document.getElementById('guest-name-prompt').style.display = 'none';
      document.getElementById('chat-container').style.display = 'flex';
      initializeRoom();
    }
  
    async function initializeRoom() {
      if (roomId) {
        localStorage.setItem('chatRoomId', roomId);
        try {
          const response = await fetch(`/api/room/${roomId}?host=${isHost}`);
          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to join room');
          }
          const data = await response.json();
          if (isHost) { document.getElementById('qr-code').style.display = 'block'; }
          let storedName, storedColor;
          if (isHost) {
            storedName = localStorage.getItem('chatHostUsername');
          } else {
            const guestName = document.getElementById('guest-name').value.trim();
            const guestInfo = getGuestInfo(guestName);
            storedName = guestName;
            storedColor = guestInfo ? guestInfo.color : null;
          }
          document.getElementById('room-id').textContent = roomId;
          const shareUrl = `${window.location.origin}/room/${roomId}`;
          document.getElementById('join-url').textContent = shareUrl;
          socket.emit('join-room', roomId, isHost, storedName, storedColor);
          document.querySelector('.welcome-screen').style.display = 'none';
          document.querySelector('.chat-container').style.display = 'flex';
          // Recalculate the minHeight once the chat container is visible
          minHeight = messageInput.scrollHeight;
          document.getElementById('message-text').focus();
          if (isHost) {
            const qrResponse = await fetch(`/api/room/${roomId}?host=true`);
            const qrData = await qrResponse.json();
            if (qrData.qrCode) {
              const qrCodeElement = document.getElementById('qr-code');
              qrCodeElement.innerHTML = `<img src="${qrData.qrCode}" alt="QR Code">`;
            }
          }
        } catch (error) {
          console.error('Error initializing room:', error);
          alert('Failed to join room. Please try again.');
          window.location.href = '/';
        }
      }
    }
  
    // Create a message element. (Note: Removed extra logging in romanji handling for performance.)
    function createMessageElement(msg, isOwn = false) {
      const messageElement = document.createElement('div');
      messageElement.classList.add('message');
      if (isOwn) { messageElement.classList.add('own'); }
      
      const usernameSpan = document.createElement('span');
      usernameSpan.className = 'username';
      usernameSpan.textContent = msg.username;
      usernameSpan.style.color = msg.color;
      messageElement.appendChild(usernameSpan);
      
      const messageContent = document.createElement('div');
      messageContent.className = 'message-content';
      messageElement.appendChild(messageContent);
      
      const originalText = document.createElement('span');
      originalText.className = 'text';
      originalText.textContent = msg.message;
      if (msg.sourceLang === 'en') {
        originalText.classList.add('en-text');
        originalText.style.display = showEnCheckbox.checked ? '' : 'none';
      } else if (msg.sourceLang === 'ja') {
        originalText.classList.add('jp-text');
        originalText.style.display = showJpCheckbox.checked ? '' : 'none';
      }
      messageContent.appendChild(originalText);
      
      if (msg.translation && msg.targetLang) {
        const translationText = document.createElement('span');
        translationText.className = 'text translation-text';
        translationText.textContent = msg.translation;
        if (msg.targetLang === 'en') {
          translationText.classList.add('en-text');
          translationText.style.display = showEnCheckbox.checked ? '' : 'none';
        } else if (msg.targetLang === 'ja') {
          translationText.classList.add('jp-text');
          translationText.style.display = showJpCheckbox.checked ? '' : 'none';
        }
        messageContent.appendChild(translationText);
      }
      
      if (msg.romanji) {
        const romanjiText = document.createElement('span');
        romanjiText.className = 'text rp-text';
        romanjiText.textContent = msg.romanji;
        romanjiText.style.display = showRpCheckbox.checked ? '' : 'none';
        messageContent.appendChild(romanjiText);
      }
      
      return messageElement;
    }
  
    // Initialize language toggle elements
    const showEnCheckbox = document.getElementById('en-toggle');
    const showJpCheckbox = document.getElementById('jp-toggle');
    const showRpCheckbox = document.getElementById('rp-toggle');
  
    // Load and save toggle states
    function loadToggleStates() {
      const showEn = localStorage.getItem('showEn');
      const showJp = localStorage.getItem('showJp');
      const showRp = localStorage.getItem('showRp');
      showEnCheckbox.checked = showEn === null ? true : showEn === 'true';
      showJpCheckbox.checked = showJp === null ? true : showJp === 'true';
      showRpCheckbox.checked = showRp === null ? true : showRp === 'true';
      updateMessageVisibility();
    }
    function saveToggleStates() {
      localStorage.setItem('showEn', showEnCheckbox.checked);
      localStorage.setItem('showJp', showJpCheckbox.checked);
      localStorage.setItem('showRp', showRpCheckbox.checked);
    }
    function updateMessageVisibility() {
      const messages = document.querySelectorAll('.message');
      messages.forEach(message => {
        const enTexts = message.querySelectorAll('.en-text');
        enTexts.forEach(text => { text.style.display = showEnCheckbox.checked ? '' : 'none'; });
        const jpTexts = message.querySelectorAll('.jp-text');
        jpTexts.forEach(text => { text.style.display = showJpCheckbox.checked ? '' : 'none'; });
        const rpTexts = message.querySelectorAll('.rp-text');
        rpTexts.forEach(text => { text.style.display = showRpCheckbox.checked ? '' : 'none'; });
      });
    }
    showEnCheckbox.addEventListener('change', () => { updateMessageVisibility(); saveToggleStates(); });
    showJpCheckbox.addEventListener('change', () => { updateMessageVisibility(); saveToggleStates(); });
    showRpCheckbox.addEventListener('change', () => { updateMessageVisibility(); saveToggleStates(); });
    loadToggleStates();
  
    // Socket event handlers
    socket.on('username-assigned', (data) => {
      username = data.username;
      userColor = data.color;
      isHost = data.isHost; // Update host status
      const welcomeMessage = document.getElementById('welcome-message');
      if (welcomeMessage) {
        welcomeMessage.innerHTML = `
            <button onclick="refreshPage()" class="refresh-button" title="Refresh page">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M23 4v6h-6"></path>
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                </svg>
            </button><span style="color: var(--color-text-white)">${username}</span>`;
      }
      if (!isHost && username) {
        storeGuestInfo(username, userColor);
        const guestNameInput = document.getElementById('guest-name');
        if (guestNameInput) { guestNameInput.style.borderColor = userColor; }
        const roomInfoLanguage = document.querySelector('.room-info-language');
        if (roomInfoLanguage) {
          roomInfoLanguage.style.backgroundColor = userColor;
        }
      }
      const sendButton = document.getElementById('send-button');
      if (sendButton) { sendButton.style.background = userColor; }
    });
  
    socket.on('user-joined', (data) => {
      addMessage({
        type: 'system',
        text: `${data.username} joined the chat`,
        color: data.color
      });
    });
    socket.on('user-left', (data) => {
      addMessage({
        type: 'system',
        text: `${data.username} left the chat`,
        color: data.color
      });
    });
    socket.on('chat-message', (msg) => {
      const messagesDiv = document.getElementById('messages');
      
      // Check if this is an update to a pending message
      const pendingMessage = document.querySelector(`[data-pending-id="${msg.username}-${msg.timestamp}"]`);
      
      if (pendingMessage) {
        // Update the existing message with translations
        const messageContent = pendingMessage.querySelector('.message-content');
        const existingTexts = messageContent.querySelectorAll('.text');
        
        // Update translations
        existingTexts.forEach(textElem => {
          if (textElem.classList.contains('translation-text') && msg.translation) {
            textElem.textContent = msg.translation;
            textElem.classList.remove('pending-translation');
          } else if (textElem.classList.contains('rp-text') && msg.romanji) {
            textElem.textContent = msg.romanji;
            textElem.classList.remove('pending-translation');
          }
        });
        
        // Remove the pending attribute
        pendingMessage.removeAttribute('data-pending-id');
      } else {
        // Create a new message element
        const messageElement = createMessageElement(msg, msg.username === username);
        messagesDiv.appendChild(messageElement);
      }
      
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
    socket.on('recent-messages', (messagesArr) => {
      const messagesDiv = document.getElementById('messages');
      messagesDiv.innerHTML = '';
      messagesArr.forEach(msg => {
        const messageElement = createMessageElement(msg, msg.username === username);
        messagesDiv.appendChild(messageElement);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  
    function addMessage(message) {
      const messagesDiv = document.getElementById('messages');
      const messageElement = document.createElement('div');
      if (message.type === 'system') {
        messageElement.className = 'message system';
        messageElement.textContent = message.text;
      } else {
        messageElement.className = `message ${message.own ? 'own' : ''}`;
        const usernameSpan = document.createElement('span');
        usernameSpan.className = 'username';
        usernameSpan.textContent = message.username;
        usernameSpan.style.color = message.color;
        const textSpan = document.createElement('span');
        textSpan.className = 'text';
        textSpan.textContent = message.text;
        messageElement.appendChild(usernameSpan);
        messageElement.appendChild(textSpan);
      }
      messagesDiv.appendChild(messageElement);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
  
    // Modify the sendMessage function to immediately display messages
    function sendMessage() {
      const messageInput = document.getElementById('message-text');
      const message = messageInput.value.trim();
      
      if (message && username) {
        // Create a timestamp for the pending message ID
        const timestamp = new Date().toISOString();
        
        // Create a pending message object
        const pendingMsg = {
          username: username,
          message: message,
          sourceLang: detectLanguageSimple(message), // Simple client-side language detection
          targetLang: detectLanguageSimple(message) === 'ja' ? 'en' : 'ja',
          color: userColor,
          timestamp: timestamp,
          messageId: `${username}-${timestamp}` // Add unique message ID
        };
        
        // Create and add the pending message to the chat
        const messagesDiv = document.getElementById('messages');
        const messageElement = createMessageElement(pendingMsg, true);
        messageElement.setAttribute('data-message-id', pendingMsg.messageId);
        
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        
        // Send the message to the server for actual translation
        socket.emit('chat-message', roomId, message, pendingMsg.messageId);

        // Clear the input and reset UI
        messageInput.value = '';
        messageInput.rows = 1;
        sendButton.classList.remove('visible');
      }
    }
  
    // Simple client-side language detection helper
    function detectLanguageSimple(text) {
      // Check if the text contains Japanese characters
      const japaneseRegex = /[\u3000-\u303f\u3040-\u309f\u30a0-\u30ff\uff00-\uff9f\u4e00-\u9faf\u3400-\u4dbf]/;
      return japaneseRegex.test(text) ? 'ja' : 'en';
    }
  
    const messageInput = document.getElementById('message-text');
    // Get the computed line-height (in pixels) for the textarea.
    const computedStyle = window.getComputedStyle(messageInput);
    const lineHeight = parseFloat(computedStyle.lineHeight);
    // Change from const to let so we can update it after the chat container is visible
    let minHeight = messageInput.scrollHeight;
  
    messageInput.addEventListener('input', function () {
      // Reset rows to the minimum (1 row) before recalculating.
      this.rows = 1;
      
      // Calculate how much extra height the current content needs.
      const extraHeight = this.scrollHeight - minHeight;
      
      // Determine how many additional rows are needed.
      const extraRows = Math.ceil(extraHeight / lineHeight);
      
      // Set the rows: one row plus any extra rows from wrapping.
      this.rows = 1 + extraRows;
    });
  
    // Message input and send button elements
    const sendButton = document.getElementById('send-button');
  
    // Function to update send button visibility
    function updateSendButtonVisibility() {
      const hasContent = messageInput.value.trim().length > 0;
      if (hasContent) {
        sendButton.classList.add('visible');
      } else {
        sendButton.classList.remove('visible');
      }
    }
  
    // Add input event listeners
    messageInput.addEventListener('input', updateSendButtonVisibility);
    messageInput.addEventListener('paste', () => {
      setTimeout(updateSendButtonVisibility, 0);
    });
  
    // Initialize button visibility
    updateSendButtonVisibility();
  
    function copyUrl() {
      const url = new URL(window.location.href);
      url.searchParams.delete('host');
      const shareUrl = url.toString();
      navigator.clipboard.writeText(shareUrl).then(() => {
        const button = document.getElementById('copy-button');
        button.textContent = 'Copied!';
        button.classList.add('copied');
        setTimeout(() => {
          button.textContent = 'Copy';
          button.classList.remove('copied');
        }, 2000);
      }).catch(err => { console.error('Failed to copy:', err); });
    }
  
    function refreshPage() {
      window.location.reload();
    }
  
    socket.on('error', (message) => {
      if (message !== 'Room not found') { alert(message); }
    });
  
    socket.on('disconnect', () => {
      console.log('Disconnected from server');
      // Do not force a reconnect here; let built-in reconnection handle it.
    });
  
    socket.on('reconnect', () => {
      console.log('Reconnected to server');
      if (username) {
        socket.emit('join-room', roomId, isHost, username, userColor);
      }
    });
  
    // Debounce helper to prevent rapid firing
    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }
  
    // Listen for when the page becomes visible (debounced)
    document.addEventListener('visibilitychange', debounce(function() {
      if (!document.hidden) {
        console.log('Page is visible.');
        if (!socket.connected) {
          console.log('Socket not connected; attempting reconnect.');
          socket.connect();
        } else if (username) {
          socket.emit('join-room', roomId, isHost, username, userColor);
        }
      }
    }, 500));
  
    // Load accordion state when room info is displayed
    const roomInfo = document.getElementById('room-info');
    const accordionObserver = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'attributes' && mutation.attributeName === 'style' && roomInfo.style.display !== 'none') {
          // Check if this is a new room
          const isNewRoom = sessionStorage.getItem('isNewRoom') === 'true';
          // Clear the flag after checking
          sessionStorage.removeItem('isNewRoom');
          // Load state with the appropriate flag
          setTimeout(() => loadAccordionState(isNewRoom), 0);
        }
      });
    });
    accordionObserver.observe(roomInfo, { attributes: true });

    // Also load state when page loads
    document.addEventListener('DOMContentLoaded', () => {
      if (roomInfo.style.display !== 'none') {
        const isNewRoom = sessionStorage.getItem('isNewRoom') === 'true';
        sessionStorage.removeItem('isNewRoom');
        loadAccordionState(isNewRoom);
      }
    });

    // Function to update placeholder based on JP toggle
    function updatePlaceholder() {
      const jpToggle = document.getElementById('jp-toggle');
      const enToggle = document.getElementById('en-toggle');
      const messageInput = document.getElementById('message-text');
      messageInput.placeholder = (jpToggle.checked && !enToggle.checked) ? '...' : 'Message...';
    }

    // Add event listener for JP toggle
    document.getElementById('jp-toggle').addEventListener('change', updatePlaceholder);

    // Add event listener for EN toggle
    document.getElementById('en-toggle').addEventListener('change', updatePlaceholder);

    // Initialize placeholder on page load
    document.addEventListener('DOMContentLoaded', updatePlaceholder);

    // Update room info language color on guest join and page load
    socket.on('username-assigned', (data) => {
      username = data.username;
      userColor = data.color;
      isHost = data.isHost;
      
      if (!isHost) {
        storeGuestInfo(username, userColor);
        const roomInfoLanguage = document.querySelector('.room-info-language');
        if (roomInfoLanguage) {
          roomInfoLanguage.style.backgroundColor = userColor;
        }
      }
      
      document.getElementById('username-display').textContent = username;
      document.querySelector('.chat-container').style.display = 'flex';
      document.querySelector('.welcome-screen').style.display = 'none';
    });

    // Initialize room info language color if guest
    document.addEventListener('DOMContentLoaded', () => {
      const storedUsername = localStorage.getItem('guestUsername');
      const storedColor = localStorage.getItem('guestColor');
      if (!isHost && storedUsername && storedColor) {
        const roomInfoLanguage = document.querySelector('.room-info-language');
        if (roomInfoLanguage) {
          roomInfoLanguage.style.backgroundColor = storedColor;
        }
      }
    });

    // Add handler for translation updates
    socket.on('translation-update', (data) => {
      const messageElement = document.querySelector(`[data-message-id="${data.messageId}"]`);
      if (messageElement) {
        // Remove existing translation elements if any
        const existingTranslation = messageElement.querySelector('.translation-text');
        const existingRomanji = messageElement.querySelector('.romanji-text');
        if (existingTranslation) existingTranslation.remove();
        if (existingRomanji) existingRomanji.remove();
        
        // Add new translation if available
        if (data.translation) {
          const translationDiv = document.createElement('div');
          translationDiv.className = 'text translation-text';
          // Add appropriate language class based on detected language
          if (data.sourceLang === 'ja') {
            translationDiv.classList.add('en-text'); // Japanese to English translation
          } else {
            translationDiv.classList.add('jp-text'); // English to Japanese translation
          }
          translationDiv.textContent = data.translation;
          messageElement.querySelector('.message-content').appendChild(translationDiv);
        }
        
        // Add new romanji if available
        if (data.romanji) {
          const romanjiDiv = document.createElement('div');
          romanjiDiv.className = 'text romanji-text rp-text';
          romanjiDiv.textContent = data.romanji;
          messageElement.querySelector('.message-content').appendChild(romanjiDiv);
        }

        // Update visibility based on current toggle states
        updateMessageVisibility();
      }
    });
  </script>  
</body>
</html>